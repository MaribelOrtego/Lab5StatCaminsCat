---
title: "Lab5 - Regressi贸 Lineal M煤ltiple: Problemes i Diagn貌stic"
subtitle: "
<div id='logo-nom-subtitle' style='text-align:center;'>
  <img src='www/logoUPC.png' style='height:50px; display:block; margin:0 auto 5px auto;'>
  <p style='margin:0; font-weight:bold; color:#0055A4 !important; font-size:16px;'>Maribel Ortego </p>
</div>"
author: "Maribel Ortego"
date: "`r format(Sys.time(), '%Y %B %d')`"

output:
  learnr::tutorial:
    progressive: false
    theme:
      bslib: true
      bootswatch: minty
    css:
      - "css/styles.css"
      - "css/hero-image-css-v2.css"
    includes:
      in_header: "www/hero-image-PiE.html"
    number_sections: TRUE
    toc: true
    toc_depth: 4
    toc_float: true

runtime: shiny_prerendered
---

```{r generaloptions, include=FALSE}
# Configuraci贸 general
library(learnr)
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 6,
  out.width = "50%",
  fig.align = "center",
  fig.caption = TRUE
)
```

#  Introducci贸

En aquest Lab veurem una regressi贸 lineal m煤ltiple que presenta problemes en la verificaci贸 de les hip貌tesis del model. A m茅s, introdu茂rem una s猫rie de contrastos d'hip貌tesis que ens permeten complementar els contrastos visuals de les hip貌tesis. Veurem una possible soluci贸 aplicable al problema observat en aquesta situaci贸.

\section{Situaci贸 de refer猫ncia}

Una companyia de manufactures desitja predir el cost unitari de fabricaci贸 $Y$ d'un nou tipus de biga en una funci贸 de la taxa de producci贸 (que varia en el temps), $X_1$, i dels costos de material i de m d'obra $X_2$. Es van recollir dades durant un per铆ode de 20 mesos durant el qual la taxa de producci贸 i els costos de material i m d'obra van experimentar una fluctuaci贸 molt mplia. La taxa de producci贸 es va mesurar com un percentatge de la capacitat total de producci贸, i es va utilitzar un 铆ndex apropiat per a reflectir els costos de material i m d'obra. Les observacions es troben al fitxer \verb"preu-biga-sim-residusprob.csv". 

Tenim com objectiu obtenir l'equaci贸 del model de regressi贸 per a predir el cost per unitat. Considerarem el cost unitari de fabricaci贸 com a variable de resposta i la taxa de producci贸 com a variable predictora.


## Lectura de dades i llibreries

::: {.infobox .caution data-latex="{caution}"}
**Recorda establir correctament el directori de treball** abans de comen莽ar a llegir les dades.
:::

En primer lloc cridarem les llibreries que necessitarem en aquest Lab:
```{r llibreries}
library(here)
library(car)
library(lmtest)
```

::: {.infobox .circle data-latex="{circle}"}

***AVS!***

Obriu el fitxer **"preu-biga-sim-residusprob.csv"** utilitzant el Bloc de notes.  
Observeu el format del fitxer. Com estan separades les columnes? amb tabulador, coma, punt i coma, espai?; Estan inclosos els noms de les variables? Hi ha files inicials amb comentaris?
:::

Llegim les dades tenint en compte la seva estructura:

```{r lectura_dades, echo=TRUE}
cb <- read.table("preu-biga-sim-residusprob.csv", sep=";", header=TRUE, dec=".")
names(cb)
```

# Predicci贸 del cost unitari. 

Predirem el log cost unitari de la biga a partir de la logtaxa de producci贸 i el logcost de material. 

Farem servir com a guia aquestes preguntes:
\begin{itemize}
\item	Executeu el model de regressi贸 m煤ltiple on es prediu el cost unitari a partir de la taxa de producci贸 i els costos de material i m d'obra. 
     \begin{itemize}
     \item Guardeu els residus sense tipificar. 
     \item Representeu els grfics de diagn貌stic del model i verifiqueu si es compleixen les hip貌tesis
     \item Valoreu la qualitat d'aquest model.
     \end{itemize}
\item	Representeu els residus guardats pr猫viament contra $X_1$ i contra $X_2$.
S'observa alguna tend猫ncia? 
\item s aconsellable utilitzar un model de regressi贸  lineal m茅s complex per a descriure el cost unitari? Quin? Estimeu els parmetres i valoreu la qualitat del nou model.
\end{itemize}


## Model inicial

Establim el model:

```{r model_inicial, echo=TRUE}
LinearModel.1 <- lm(logCostbiga ~ logTaxaProd + logCostMaterial, data=cb)
```

Donat que es tracta d'un model de regressi贸 lineal m煤ltiple, cal controlar la colinealitat de les variables predictores: 

### Exercici: "Calcula el vif del model executat"

```{r model_inicialvif, exercise=TRUE}

```

Una vegada descartada la colinealitat entre les variables predictores, cal valorar si es compleixen les hip貌tesis del model. 

::: {.infobox .travel data-latex="{travel}"}
 Recorda que les hip貌tesis del model s'estableixen sobre els residus. Els residus han de ser centrats, homocedstics (mateixa varian莽a), incorrelacionats i amb distribuci贸 normal:
\[\epsilon_i \sim N(0, $\sigma^2$) \ , incorrelacionats  \ . \] 
:::

Representem les grfiques de diagn貌stic conjuntament:
```{r model_inicial_plots, echo=TRUE, fig.cap="Diagnostic plots for LinearModel.1"}
par(mfrow=c(2,2))
plot(LinearModel.1)
par(mfrow=c(1,1))
```
A continuaci贸 representem les grfiques individualment, per a poder-les interpretar millor. En primer lloc representem la Grfica de Residus contra valors predits. Recordeu que en aquesta grfica comprovem visualment si els residus tenen mitjana 0, si s贸n homocedstics i si s贸n incorrelacionats.

```{r diagnostic_residuals_vs_fitted, echo=TRUE, fig.cap="Grfic Residuals vs Valors Predits"}
plot(LinearModel.1, which=1)
```
Qu猫 hi veieu a la grfica? Complim les tres hip貌tesis esmentades?

Recordeu que la grfica Scale-Location ens serveix per a profunditzar en la valoraci贸 d'aquestes hip貌tesis. Qu猫 hi veieu?

```{r diagnostic_scale_location, echo=TRUE, fig.cap="Grfic Scale-Location"}
plot(LinearModel.1, which=3)
```

A continuaci贸 representem el `qqplot` de normalitat proporcionat per defecte. En aquesta grfica comprovem visualment si podem considerar que la distribuci贸 dels residus 茅s normal.

```{r diagnostic_normal_qq, echo=TRUE, fig.cap="Grfic Q-Q dels residus"}
plot(LinearModel.1, which=2)
```

Veient la grfica, tenim motius per a rebutjar que els residus tiguin distribuci贸 normal?

I per 煤ltim, la grfica dels punts d'influ猫ncia ens permet detectar _punts palanca_ , punts que influeixen molt en el nostre model i que hem d'estudiar detingudament. Amb aquest grfic no comprovem cap hip貌tesi del model, per貌 茅s 煤til, donada la influ猫ncia que els punts palanca poden tenir en la interpretaci贸 del nostre model. Recordeu que considerem que un punt 茅s influent si la seva distncia de Cook 茅s superior a 1, i per aix貌 la grfica indica la zona de distncia de Cook superior a 0.5 i a 1 respectivament. Observem que el punt 5 茅s un punt influent.

```{r diagnostic_leverage, echo=TRUE, fig.cap="Grfic Residuals vs Leverage"}
plot(LinearModel.1, which=5)
```

### Profunditzem la interpretaci贸: Normalitat dels residus

El grfic de diagn貌stic per a la normalitat del residus es pot millorar afegint-hi bandes de confian莽a.

### Exercici: "Representa el `qqPlot` dels residus incloent una banda de confian莽a del 95%". 

```{r normalitat_residus_qqplot,exercise=TRUE, exercise.has_hint=TRUE}

```

```{r normalitat_residus_qqplot-hint,echo=FALSE}
Utilitza la funci贸 inclosa al paquet `car` per a fer la grfica demanada.
```
Observem que hi ha alguns punts que queden fora de la banda de confian莽a  del qqPlot que per defecte 茅s del 95$\%$.
Per a millorar l'interpretaci贸, podr铆em canviar l'amplada de la banda de confian莽a,  per una del 99$\%$:

### Exercici:

```{r qqplot-parametre-quiz, echo=FALSE}
quiz(
  question("Consulta l'ajuda de la funci贸 `qqPlot`. Quin 茅s el nom del parmetre amb qu猫 podem modificar l'amplada de la banda de confian莽a?",
    answer("band"),
    answer("envelope", correct = TRUE),
    answer("conf"),
    answer("altres")
  )
)
```

Tornem a representar el `qqPlot` amb una banda de confian莽a de 99$\%$:

```{r normalitat_residus_qplot2, echo=TRUE, fig.cap="Q-Q plot amb sobre d'envolupament per a LinearModel.1"}
car::qqPlot(LinearModel.1$residuals, envelope=list(level=0.99))
```
Observem que el punt 5 queda fora de la banda. Com s贸n poques observacions, una d'elles 茅s m茅s de l'1$\%$ de les observacions, i per tant haur铆em de rebutjar la hip貌tesi primria de normalitat.

Per貌 recorda que conv茅 complementar sempre els diagn貌stics visuals amb un contrast d'hip貌tesis. En aquest cas necessitem un contrast de bondat d'ajust de la normal.

Per exemple, podem utilitzar el contrast de Kolmogorov-Smirnov. Aquest 茅s un contrast general, que podem aplicar considerant qualsevol model continu com a model de refer猫ncia. Aquest contrast mesura difer猫ncies entre la funci贸 de distribuci贸 emp铆rica dels residus i la funci贸 de distribuci贸 de refer猫ncia, la normal en aquest cas:

```{r testnorm_residus_qplot2, echo=TRUE}
ks.test(LinearModel.1$residuals, 'pnorm')
```

### Exercici:

```{r ks-test-quiz, echo=FALSE}
quiz(
  question("Donat els resultats del contrast de Kolmogorov-Smirnov, i donat un nivell de significaci贸 $ \alpha =0.05$, la decisi贸 que hem de prendre 茅s:",
    answer("Rebutjar la hip貌tesi primria, 茅s a dir, no podem considerar que els residus del model siguin normals", correct = TRUE),
    answer("No podem rebutjar la hip貌tesi primria, 茅s a dir, no podem considerar que els residus del model siguin normals"),
    answer("No podem rebutjar la hip貌tesi primria, 茅s a dir, podem considerar que els residus del model s贸n normals"),
    answer("Cap de les anteriors")
  )
)
```

Apart del contrast general K-S, tamb茅 podem utilitzar d'altres contrastos que s贸n espec铆fics per a normalitat, 茅s a dir, que nom茅s poden considerar la normal com a distribuci贸 de refer猫ncia:

### Exercici: Aplica un test espec铆fic de normalitat als residus

```{r testnorm_residus_qplot22, exercise=TRUE, exercise.has_hint=TRUE}

```

```{r testnorm_residus_qplot22-hint}
Per exemple, pots utilitzar Shapiro-Wilks
```

Hi ha nombrosos tests  de bondat d'ajust espec铆fics per a normalitat. Els estad铆stics de contrast mesuren difer猫ncies en zones diferents de la distribuci贸 (uns es centren en les difer猫ncies a les cues, d'altres al centre de la distribuci贸). Per aix貌 podr铆em tenir conclusions diferents si n'utilitzem m茅s d'un. Per貌 tot i aix貌, o precisament per aix貌, conv茅 utilitzar-ne m茅s d'un, per exemple l'Anderson-Darling:

```{r contrastos_residus_extra, echo=TRUE}
nortest::ad.test(LinearModel.1$residuals)
```

Quina 茅s la conclusi贸 que treiem?

::: {.infobox .caution data-latex="{caution}"}
A partir d'ara, quan realitzeu la comprovaci贸 de les hip貌tesis del model, no nom茅s ho fareu visualment, sino complementant amb els contrastos que pertoquin.
:::

### Profunditzem la interpretaci贸: homocedasticitat dels residus

Com a complement del grfic de Residus contra valors ajustats, plantejarem el contrast d'hip貌tesis de Breusch-Pagan, en el que contrastarem:

$$H_{0}: \text{ Els residus s贸n homocedstics (茅s a dir, la varian莽a dels residus 茅s constant)}$$
$$H_{1}: \text{ Els residus s贸n heterocedstics (茅s a dir, la varian莽a dels residus no 茅s constant)}$$

```{r contrastos_residus_extra2, echo=TRUE}
lmtest::bptest(LinearModel.1)
```

Quina conclusi贸 obtenim en aquest cas?

### Profunditzem la interpretaci贸: incorrelaci贸 dels residus

Com a complement del grfic de Residus contra valors ajustats, aplicarem el test de Durbin-Watson, que contrasta si els residus s贸n incorrelacionats

$$H_{0}: \text{ Els residus tenen correlaci贸 nu路la (茅s a dir, s贸n incorrelacionats)}$$
$$H_{0}: \text{ Els residus tenen correlaci贸 diferent de zero (茅s a dir, s贸n correlacionats)}$$

```{r contrastos_residus_extra3, echo=TRUE}
lmtest::dwtest(LinearModel.1, alternative = "two.sided")
```
Quina conclusi贸 hem de treure en aquest cas?

## Resum del model 
 
 En aquest cas NO complim les hip貌tesis del model. Cal solucionar-ho abans de valorar el resum del model. Donat que no es compleixen les hip貌tesis, les conclusions que obtinguem podrien ser err貌nies.

<!-- ```{r summary_model1, echo=TRUE} -->
<!-- summary(LinearModel.1) -->
<!-- ``` -->

# Problemes al model

Veient els diagn貌stics sobre els residus veiem que no es compleixen les hip貌tesis del model, i per tant cal solucionar-los  abans de seguir amb la interpretaci贸 del model.

Solucionar problemes amb les hip貌tesis del model no sempre 茅s fcil. 

## Problemes amb la incorrelaci贸 dels residus. Primer enfoc: diagn貌stic visual,  relaci贸 amb predictors

Els residus del model s贸n la difer猫ncia entre els valors observats i els valors predits pel model. Aquestes difer猫ncies poden ser degudes a variables que no hem mesurat o al fet que les variables utilitzades hagin d'estar presents en altres escales, entre d'altres causes. En aquest exemple no disposem de m茅s variables que incloure al model, per貌 s铆 podem visualitzar si hi ha relaci贸 entre les variables predictores disponibles i els residus:

```{r diagnostica_predictors1, echo=TRUE, fig.cap="Residuals vs variables predictores"}
par(mfrow=c(1,2))
plot(cb$logCostMaterial, LinearModel.1$residuals)
plot(cb$logTaxaProd, LinearModel.1$residuals)
par(mfrow=c(1,1))
```

Veiem que els residus contenen clarament una influ猫ncia quadrtica de la taxa de producci贸. Per tant, per a intentar solventar el problema de correlaci贸 dels residus, podem definir un nou model de regressi贸 que inclogui aquesta variable al quadrat.

# Segon model

Definirem un model polinomial amb les dues variables predictores:

## Segon model: definici贸

Com hem vist que hi ha una influ猫ncia quadrtica de logTaxa, definim la variable logTaxa al quadrat. A continuaci贸 establim el nou model de regressi贸. Posteriorment controlem la col路linealitat:

```{r nou_model, echo=TRUE}
cb$logTaxaProdsq <- cb$logTaxaProd * cb$logTaxaProd
LinearModel.2 <- lm(logCostbiga ~ logTaxaProdsq + logCostMaterial, data=cb)
vif(LinearModel.2)
```

Representem els grfics de diagn貌stic per a verificar si es compleixen les hip貌tesis del model:

```{r nou_model_plots, echo=TRUE, fig.cap="Diagnostic plots for LinearModel.2"}
par(mfrow=c(2,2))
plot(LinearModel.2)
par(mfrow=c(1,2))
```

Ens centrem amb el grfic de diagn貌stic que m茅s problemes presentava:

```{r residuals_vs_fitted_model2, echo=TRUE, fig.cap="Grfic Residuals vs Valors Predits per a LinearModel.2"}
plot(LinearModel.2, which=1)
```

Reviseu el plot: els redidus s贸n centrats? S贸n homocedstics? S贸n incorrelacionats?

Complementem amb els contrastos presentats anteriorment:

```{r contrastos_residus, echo=TRUE}
lmtest::bptest(LinearModel.2)
lmtest::dwtest(LinearModel.2, alternative = "two.sided")
```
Quines conclusions obtenim dels contrastos? S贸n les mateixes que hav铆em obtingut visualment?

## Contrastem la normalitat dels residus

A m茅s del grfic proporcionat per defecte, representem el `qqPlot` de normalitat dels residus del model, que afegeix la banda de confian莽a:

```{r nou_model_plots_qq, echo=TRUE, fig.cap="Q-Q plot dels residus de LinearModel.2"}
qqPlot(LinearModel.2$residuals)
```
Hi ha motius per a rebutjar la normalitat dels residus?

Complementem el diagn貌stic de normalitat amb els contrastos de bondat d'ajust:

```{r contrastos_residus2, echo=TRUE}
shapiro.test(LinearModel.2$residuals)
ks.test(LinearModel.2$residuals, 'pnorm')
nortest::ad.test(LinearModel.2$residuals)
```

### Exercici: 

```{r contrastos-normalitat-model2-quiz, echo=FALSE}
quiz(
  question("Donat els contrastos de bondat d'ajust normal, quina decisi贸 hem de prendre?",
    answer("Rebutjar la hip貌tesi primria, 茅s a dir, no podem considerar que els residus del model siguin normals"),
    answer("No podem rebutjar la hip貌tesi primria, 茅s a dir, no podem considerar que els residus del model siguin normals"),
    answer("No podem rebutjar la hip貌tesi primria, 茅s a dir, podem considerar que els residus del model s贸n normals", correct = TRUE),
    answer("Cap de les anteriors")
  )
)
```


Per tant, veiem que en aquest segon model s铆 que es compleixen les hip貌tesis de la regressi贸, i per tant, ara procedirem amb la interpretaci贸 complerta del model:

## Resum del nou model

::: {.infobox .travel data-latex="{travel}"}
En el resum del model verificarem, en aquest ordre, el contrast `F`; els contrastos `t` i el coeficient de determinaci贸 $R^2$, per a valorar la conveni猫nci i la bondat d'ajust del model de regressi贸 definit.
:::

```{r summary_model2, echo=TRUE}
summary(LinearModel.2)
```

En primer lloc observem el resultat del contrast F ("tots els coeficients del model excepte $\beta_0$ s贸n nuls" vs "alguns s贸n no nuls"). Observem que el p-valor 茅s molt petit (p-value: < 2.2e-16) i per tant rebutgem la hip貌tesi primria. s a dir, el model lineal t茅 sentit.
A continuaci贸 contrastem si els coeficients s贸n nuls un a un ($\beta_i=0$ vs $\beta_i \neq 0$). Veiem que pels tres coeficients, el p-valor 茅s molt petit (<2e-16) i per tant rebutgem l'hip貌tesi primria pels tres coeficients. s a dir, mantenim la ordenada a l'origen i les dues variables al model.

Finalment, observem el valor del coeficient de determinaci贸 $R^2$, que 茅s 1 (probablement sigui >0.99 i el sistema arrodoneix). s un ajust excel路lent.

Per tant, hem trobat un model molt bo.

### Exercici: 

Observeu els coeficients estimats. Quant pujar el preu de la biga si augmentem una unitat la Taxa de producci贸 i una unitat el cost de producci贸?

## Verifiquem 

Hem millorat for莽a el model respecte el que hem establert inicialment. Verifiquem que els residus d'aquest model no contenen efectes no lineals de les variables predictores:

```{r diagnostica_predictors2, echo=TRUE, fig.cap="Residuals vs logTaxaProd per a LinearModel.2"}
plot(cb$logTaxaProd, LinearModel.2$residuals)
```

# Altres problemes que podem trobar

A les aplicacions ens podem trobar que els residus del model plantejat no compleixen una o m茅s de les hip貌tesis del model de regressi贸 m煤ltiple. Hem vist un cas on hem pogut solucionar el problema de correlaci贸 dels residus. Per貌 no sempre 茅s fcil, i algunes solucions queden fora de l'abast de la nostra assignatura introduct貌ria. Aqu铆 teniu un parell de suggeriments sobre problemes t铆pics:

* _Residus no normals_. La normalitat dels residus 茅s la base per a que la distribuci贸 de l'estad铆stic de contrast F sigui una F de Fisher o per a que la distribuci贸 de l'estad铆stic de contrast t sigui una t-Student. Si no hi ha normalitat, no podem interpretar adequadament els p-valors obtinguts en aquests contrastos, a no ser que siguin molt extrems. s a dir, si no hi ha normalitat, podem rebutjar la $H_0$ si el p-valor 茅s molt petit  (<2e-16 p.ex.) o no podem rebutjar si 茅s p-valor 茅s molt gran (>0.9), per貌 no podem decidir en els valors intermitjos, perqu猫 la distribuci贸 de l'estad铆stic no ser F (o t).

* _Residus correlacionats_. Una altra situaci贸 que pot causar el tenir residus correlacionats s贸n les variables predictores colineals. Cal inspeccionar colinealitat i aplicar t猫cniques com l'anlisi de components principals per a generar predictors no correlacionats.

* Altres problemes dels residus s'han d'analitzar per al problema de refer猫ncia i buscar solucions ad hoc.

# Conclusi贸 {-}

Aquest exercici ens ha perm猫s observar com  els problemes amb els sup貌sits del model poden correspondre amb una definici贸 incomplerta del model i com petites transformacions poden millorar-ne lajust i la interpretabilitat.

# About / Canvis {-}

Material creat per M. Ortego per a les assignatures de Probabilitat i Estad铆stica de lETSECCPB - UPC.

Versi贸 1.0
